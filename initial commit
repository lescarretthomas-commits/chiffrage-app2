<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RelevÃ© Chiffrage Sinistre</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useRef } = React;

    const PIECES_PREDEFINES = [
      'Cuisine', 'Salon', 'Salle Ã  manger', 'Chambre', 'Salle de bain', 
      'WC', 'EntrÃ©e', 'Couloir', 'Bureau', 'Garage', 'Cave', 'Grenier'
    ];

    const PRESTATIONS_PREDEFINES = [
      'Peinture murs',
      'Peinture plafond',
      'RevÃªtement sol (carrelage)',
      'RevÃªtement sol (parquet)',
      'RevÃªtement sol (moquette)',
      'Plomberie (remplacement sanitaires)',
      'Plomberie (robinetterie)',
      'Ã‰lectricitÃ© (prises/interrupteurs)',
      'Ã‰lectricitÃ© (Ã©clairage)',
      'Menuiserie (portes intÃ©rieures)',
      'Menuiserie (fenÃªtres)',
      'Menuiserie (placards)',
      'PlÃ¢trerie (doublage)',
      'PlÃ¢trerie (cloisons)',
      'Chauffage (radiateurs)',
      'Isolation',
      'FaÃ¯ence murale',
      'Nettoyage aprÃ¨s travaux'
    ];

    // IcÃ´nes SVG simplifiÃ©es
    const Camera = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>;
    const Plus = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
    const Trash = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
    const Edit = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>;
    const X = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
    const Check = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="20 6 9 17 4 12"></polyline></svg>;
    const Download = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;

    function ChiffrageApp() {
      const [dossier, setDossier] = useState({
        numero: '',
        nom: '',
        adresse: ''
      });
      
      const [pieces, setPieces] = useState([]);
      const [currentPiece, setCurrentPiece] = useState(null);
      const [showPieceModal, setShowPieceModal] = useState(false);
      const [showCroquis, setShowCroquis] = useState(false);
      
      const fileInputRef = useRef(null);
      const canvasRef = useRef(null);
      const [isDrawing, setIsDrawing] = useState(false);

      const ajouterPiece = (nomPiece) => {
        const nouvellePiece = {
          id: Date.now(),
          nom: nomPiece,
          longueur: '',
          largeur: '',
          hauteur: '',
          surfaceSol: 0,
          surfacePlafond: 0,
          surfaceMurs: 0,
          photos: [],
          croquis: null,
          prestations: []
        };
        setPieces([...pieces, nouvellePiece]);
        setShowPieceModal(false);
      };

      const ajouterPrestation = (pieceId, nomPrestation) => {
        setPieces(pieces.map(p => {
          if (p.id === pieceId) {
            return {
              ...p,
              prestations: [...p.prestations, {
                id: Date.now(),
                nom: nomPrestation,
                quantite: 1,
                prixUnitaire: 0,
                unite: 'mÂ²'
              }]
            };
          }
          return p;
        }));
      };

      const modifierPrestation = (pieceId, prestationId, champ, valeur) => {
        setPieces(pieces.map(p => {
          if (p.id === pieceId) {
            return {
              ...p,
              prestations: p.prestations.map(pr => {
                if (pr.id === prestationId) {
                  return { ...pr, [champ]: valeur };
                }
                return pr;
              })
            };
          }
          return p;
        }));
      };

      const supprimerPrestation = (pieceId, prestationId) => {
        setPieces(pieces.map(p => {
          if (p.id === pieceId) {
            return {
              ...p,
              prestations: p.prestations.filter(pr => pr.id !== prestationId)
            };
          }
          return p;
        }));
      };

      const calculerSurface = (pieceId) => {
        setPieces(pieces.map(p => {
          if (p.id === pieceId && p.longueur && p.largeur && p.hauteur) {
            const longueur = parseFloat(p.longueur);
            const largeur = parseFloat(p.largeur);
            const hauteur = parseFloat(p.hauteur);
            
            // Surface sol et plafond (identiques)
            const surfaceSol = (longueur * largeur).toFixed(2);
            const surfacePlafond = surfaceSol;
            
            // Surface des murs (pÃ©rimÃ¨tre Ã— hauteur)
            const perimetre = 2 * (longueur + largeur);
            const surfaceMurs = (perimetre * hauteur).toFixed(2);
            
            return {
              ...p,
              surfaceSol: surfaceSol,
              surfacePlafond: surfacePlafond,
              surfaceMurs: surfaceMurs
            };
          }
          return p;
        }));
      };

      const ajouterPhoto = (pieceId, file) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          setPieces(pieces.map(p => {
            if (p.id === pieceId) {
              return {
                ...p,
                photos: [...p.photos, { id: Date.now(), data: reader.result }]
              };
            }
            return p;
          }));
        };
        reader.readAsDataURL(file);
      };

      const supprimerPhoto = (pieceId, photoId) => {
        setPieces(pieces.map(p => {
          if (p.id === pieceId) {
            return {
              ...p,
              photos: p.photos.filter(ph => ph.id !== photoId)
            };
          }
          return p;
        }));
      };

      const supprimerPiece = (pieceId) => {
        setPieces(pieces.filter(p => p.id !== pieceId));
      };

      const startDrawing = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const ctx = canvas.getContext('2d');
        const x = e.touches ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
        const y = e.touches ? e.touches[0].clientY - rect.top : e.clientY - rect.top;
        ctx.beginPath();
        ctx.moveTo(x, y);
        setIsDrawing(true);
      };

      const draw = (e) => {
        if (!isDrawing) return;
        e.preventDefault();
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const ctx = canvas.getContext('2d');
        const x = e.touches ? e.touches[0].clientX - rect.left : e.clientX - rect.left;
        const y = e.touches ? e.touches[0].clientY - rect.top : e.clientY - rect.top;
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
      };

      const stopDrawing = () => {
        setIsDrawing(false);
      };

      const sauvegarderCroquis = (pieceId) => {
        const canvas = canvasRef.current;
        const croquisData = canvas.toDataURL();
        setPieces(pieces.map(p => {
          if (p.id === pieceId) {
            return { ...p, croquis: croquisData };
          }
          return p;
        }));
        setShowCroquis(false);
        setCurrentPiece(null);
      };

      const effacerCroquis = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      };

      const calculerTotalDossier = () => {
        return pieces.reduce((total, piece) => {
          const totalPiece = piece.prestations.reduce((sum, p) => {
            return sum + (parseFloat(p.quantite) || 0) * (parseFloat(p.prixUnitaire) || 0);
          }, 0);
          return total + totalPiece;
        }, 0);
      };

      const exporterDossier = () => {
        const data = {
          dossier,
          pieces,
          total: calculerTotalDossier(),
          date: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chiffrage_${dossier.numero || 'nouveau'}_${Date.now()}.json`;
        a.click();
      };

      const exporterWord = () => {
        let htmlContent = `
          <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                xmlns:w='urn:schemas-microsoft-com:office:word' 
                xmlns='http://www.w3.org/TR/REC-html40'>
          <head><meta charset='utf-8'><title>Chiffrage ${dossier.numero}</title></head>
          <body>
            <h1 style='color: #2563eb; border-bottom: 3px solid #2563eb; padding-bottom: 10px;'>
              ðŸ“‹ RelevÃ© Chiffrage Sinistre
            </h1>
            
            <div style='margin: 20px 0; padding: 15px; background-color: #f3f4f6; border-radius: 5px;'>
              <p><strong>NÂ° Dossier:</strong> ${dossier.numero}</p>
              <p><strong>Nom:</strong> ${dossier.nom}</p>
              <p><strong>Adresse:</strong> ${dossier.adresse}</p>
              <p><strong>Date:</strong> ${new Date().toLocaleDateString('fr-FR')}</p>
            </div>
        `;

        pieces.forEach((piece, index) => {
          htmlContent += `
            <div style='page-break-inside: avoid; margin: 30px 0; border: 2px solid #e5e7eb; padding: 20px; border-radius: 8px;'>
              <h2 style='color: #1f2937; border-bottom: 2px solid #3b82f6; padding-bottom: 10px;'>
                ${index + 1}. ${piece.nom}
              </h2>
              
              <div style='margin: 15px 0;'>
                <h3 style='color: #374151;'>Dimensions</h3>
                <p><strong>Longueur:</strong> ${piece.longueur} m | <strong>Largeur:</strong> ${piece.largeur} m | <strong>Hauteur:</strong> ${piece.hauteur} m</p>
              </div>
              
              <div style='background-color: #eff6ff; padding: 15px; margin: 15px 0; border-radius: 5px;'>
                <h3 style='color: #1e40af; margin-top: 0;'>Surfaces calculÃ©es</h3>
                <p><strong>Surface Sol:</strong> ${piece.surfaceSol || 0} mÂ²</p>
                <p><strong>Surface Plafond:</strong> ${piece.surfacePlafond || 0} mÂ²</p>
                <p><strong>Surface Murs:</strong> ${piece.surfaceMurs || 0} mÂ²</p>
              </div>
          `;

          if (piece.croquis) {
            htmlContent += `
              <div style='margin: 15px 0;'>
                <h3 style='color: #374151;'>Croquis</h3>
                <img src='${piece.croquis}' style='max-width: 400px; border: 1px solid #d1d5db;' />
              </div>
            `;
          }

          if (piece.photos.length > 0) {
            htmlContent += `
              <div style='margin: 15px 0;'>
                <h3 style='color: #374151;'>Photos (${piece.photos.length})</h3>
                <div style='display: flex; flex-wrap: wrap; gap: 10px;'>
            `;
            piece.photos.forEach(photo => {
              htmlContent += `<img src='${photo.data}' style='width: 150px; height: 150px; object-fit: cover; border: 1px solid #d1d5db;' />`;
            });
            htmlContent += `</div></div>`;
          }

          if (piece.prestations.length > 0) {
            htmlContent += `
              <div style='margin: 15px 0;'>
                <h3 style='color: #374151;'>Prestations</h3>
                <table border='1' cellpadding='8' cellspacing='0' style='width: 100%; border-collapse: collapse; border: 1px solid #d1d5db;'>
                  <thead style='background-color: #f9fafb;'>
                    <tr>
                      <th style='text-align: left;'>Prestation</th>
                      <th style='text-align: center;'>QuantitÃ©</th>
                      <th style='text-align: center;'>UnitÃ©</th>
                      <th style='text-align: right;'>Prix Unit.</th>
                      <th style='text-align: right;'>Total</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            let totalPiece = 0;
            piece.prestations.forEach(p => {
              const total = (parseFloat(p.quantite) || 0) * (parseFloat(p.prixUnitaire) || 0);
              totalPiece += total;
              htmlContent += `
                <tr>
                  <td>${p.nom}</td>
                  <td style='text-align: center;'>${p.quantite}</td>
                  <td style='text-align: center;'>${p.unite}</td>
                  <td style='text-align: right;'>${parseFloat(p.prixUnitaire).toFixed(2)}â‚¬</td>
                  <td style='text-align: right;'>${total.toFixed(2)}â‚¬</td>
                </tr>
              `;
            });

            htmlContent += `
                  </tbody>
                  <tfoot style='background-color: #f3f4f6; font-weight: bold;'>
                    <tr>
                      <td colspan='4' style='text-align: right;'>Total piÃ¨ce:</td>
                      <td style='text-align: right;'>${totalPiece.toFixed(2)}â‚¬</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            `;
          }

          htmlContent += `</div>`;
        });

        htmlContent += `
            <div style='margin-top: 40px; padding: 20px; background-color: #dbeafe; border: 3px solid #2563eb; border-radius: 8px;'>
              <h2 style='color: #1e40af; margin-top: 0;'>TOTAL GÃ‰NÃ‰RAL: ${calculerTotalDossier().toFixed(2)}â‚¬</h2>
            </div>
          </body>
          </html>
        `;

        const blob = new Blob(['\ufeff', htmlContent], {
          type: 'application/msword'
        });

        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Chiffrage_${dossier.numero || 'nouveau'}_${Date.now()}.doc`;
        link.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-6xl mx-auto">
            {/* En-tÃªte */}
            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
              <h1 className="text-2xl font-bold text-gray-800 mb-4">ðŸ“‹ RelevÃ© Chiffrage Sinistre</h1>
              
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">NÂ° Dossier</label>
                  <input
                    type="text"
                    value={dossier.numero}
                    onChange={(e) => setDossier({...dossier, numero: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    placeholder="2024-001"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                  <input
                    type="text"
                    value={dossier.nom}
                    onChange={(e) => setDossier({...dossier, nom: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    placeholder="M. Dupont"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Adresse Chantier</label>
                  <input
                    type="text"
                    value={dossier.adresse}
                    onChange={(e) => setDossier({...dossier, adresse: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    placeholder="15 rue..."
                  />
                </div>
              </div>
            </div>

            {/* Bouton Ajouter PiÃ¨ce */}
            <button
              onClick={() => setShowPieceModal(true)}
              className="bg-blue-600 text-white px-4 py-2 rounded-md flex items-center gap-2 mb-6 hover:bg-blue-700"
            >
              <Plus /> Ajouter une piÃ¨ce
            </button>

            {/* Liste des piÃ¨ces */}
            {pieces.map((piece) => (
              <div key={piece.id} className="bg-white rounded-lg shadow-md p-6 mb-6">
                <div className="flex justify-between items-start mb-4">
                  <h2 className="text-xl font-bold text-gray-800">{piece.nom}</h2>
                  <button
                    onClick={() => supprimerPiece(piece.id)}
                    className="text-red-600 hover:text-red-800"
                  >
                    <Trash />
                  </button>
                </div>

                {/* Dimensions */}
                <div className="grid md:grid-cols-4 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Longueur (m)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={piece.longueur}
                      onChange={(e) => {
                        setPieces(pieces.map(p => p.id === piece.id ? {...p, longueur: e.target.value} : p));
                      }}
                      onBlur={() => calculerSurface(piece.id)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Largeur (m)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={piece.largeur}
                      onChange={(e) => {
                        setPieces(pieces.map(p => p.id === piece.id ? {...p, largeur: e.target.value} : p));
                      }}
                      onBlur={() => calculerSurface(piece.id)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Hauteur (m)</label>
                    <input
                      type="number"
                      step="0.01"
                      value={piece.hauteur}
                      onChange={(e) => {
                        setPieces(pieces.map(p => p.id === piece.id ? {...p, hauteur: e.target.value} : p));
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Surface (mÂ²)</label>
                    <input
                      type="text"
                      value={piece.surface}
                      readOnly
                      className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50"
                    />
                  </div>
                </div>

                {/* Croquis */}
                <div className="mb-4">
                  <button
                    onClick={() => {
                      setCurrentPiece(piece.id);
                      setShowCroquis(true);
                    }}
                    className="bg-green-600 text-white px-4 py-2 rounded-md flex items-center gap-2 hover:bg-green-700"
                  >
                    <Edit /> {piece.croquis ? 'Modifier' : 'CrÃ©er'} le croquis
                  </button>
                  {piece.croquis && (
                    <img src={piece.croquis} alt="Croquis" className="mt-2 border border-gray-300 rounded max-w-xs" />
                  )}
                </div>

                {/* Photos */}
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Photos</label>
                  <div className="flex gap-2 flex-wrap items-center">
                    {piece.photos.map((photo) => (
                      <div key={photo.id} className="relative">
                        <img src={photo.data} alt="Photo" className="w-24 h-24 object-cover rounded border" />
                        <button
                          onClick={() => supprimerPhoto(piece.id, photo.id)}
                          className="absolute -top-2 -right-2 bg-red-600 text-white rounded-full p-1"
                        >
                          <X />
                        </button>
                      </div>
                    ))}
                    <button
                      onClick={() => {
                        fileInputRef.current?.click();
                        fileInputRef.current.onchange = (e) => {
                          const file = e.target.files[0];
                          if (file) ajouterPhoto(piece.id, file);
                        };
                      }}
                      className="w-24 h-24 border-2 border-dashed border-gray-300 rounded flex items-center justify-center hover:border-blue-500"
                    >
                      <Camera />
                    </button>
                  </div>
                </div>

                {/* Prestations */}
                <div>
                  <h3 className="text-lg font-semibold text-gray-800 mb-2">Prestations</h3>
                  
                  <div className="mb-4">
                    <select
                      onChange={(e) => {
                        if (e.target.value) {
                          ajouterPrestation(piece.id, e.target.value);
                          e.target.value = '';
                        }
                      }}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                      <option value="">SÃ©lectionner une prestation...</option>
                      {PRESTATIONS_PREDEFINES.map((p) => (
                        <option key={p} value={p}>{p}</option>
                      ))}
                    </select>
                    <input
                      type="text"
                      placeholder="Ou saisir une prestation personnalisÃ©e..."
                      className="w-full px-3 py-2 border border-gray-300 rounded-md mt-2"
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && e.target.value.trim()) {
                          ajouterPrestation(piece.id, e.target.value.trim());
                          e.target.value = '';
                        }
                      }}
                    />
                  </div>

                  <div className="space-y-2">
                    {piece.prestations.map((prestation) => (
                      <div key={prestation.id} className="grid grid-cols-12 gap-2 items-center bg-gray-50 p-2 rounded">
                        <div className="col-span-4">
                          <input
                            type="text"
                            value={prestation.nom}
                            onChange={(e) => modifierPrestation(piece.id, prestation.id, 'nom', e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                          />
                        </div>
                        <div className="col-span-2">
                          <input
                            type="number"
                            step="0.01"
                            value={prestation.quantite}
                            onChange={(e) => modifierPrestation(piece.id, prestation.id, 'quantite', e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                          />
                        </div>
                        <div className="col-span-2">
                          <select
                            value={prestation.unite}
                            onChange={(e) => modifierPrestation(piece.id, prestation.id, 'unite', e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                          >
                            <option>mÂ²</option>
                            <option>ml</option>
                            <option>u</option>
                            <option>forfait</option>
                          </select>
                        </div>
                        <div className="col-span-2">
                          <input
                            type="number"
                            step="0.01"
                            value={prestation.prixUnitaire}
                            onChange={(e) => modifierPrestation(piece.id, prestation.id, 'prixUnitaire', e.target.value)}
                            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
                            placeholder="Prix"
                          />
                        </div>
                        <div className="col-span-1 text-right font-semibold text-sm">
                          {((parseFloat(prestation.quantite) || 0) * (parseFloat(prestation.prixUnitaire) || 0)).toFixed(2)}â‚¬
                        </div>
                        <div className="col-span-1">
                          <button
                            onClick={() => supprimerPrestation(piece.id, prestation.id)}
                            className="text-red-600 hover:text-red-800"
                          >
                            <Trash />
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>

                  <div className="mt-4 text-right">
                    <span className="text-lg font-bold">
                      Total piÃ¨ce: {piece.prestations.reduce((sum, p) => 
                        sum + (parseFloat(p.quantite) || 0) * (parseFloat(p.prixUnitaire) || 0), 0
                      ).toFixed(2)}â‚¬
                    </span>
                  </div>
                </div>
              </div>
            ))}

            {/* Total gÃ©nÃ©ral et export */}
            {pieces.length > 0 && (
              <div className="bg-blue-50 rounded-lg shadow-md p-6 mb-6">
                <div className="flex justify-between items-center">
                  <div>
                    <h2 className="text-2xl font-bold text-blue-800">
                      TOTAL GÃ‰NÃ‰RAL: {calculerTotalDossier().toFixed(2)}â‚¬
                    </h2>
                  </div>
                  <button
                    onClick={exporterWord}
                    className="bg-blue-600 text-white px-6 py-3 rounded-md flex items-center gap-2 hover:bg-blue-700"
                  >
                    <Download /> Exporter Word (.doc)
                  </button>
                </div>
                <p className="text-sm text-gray-600 mt-2">
                  ðŸ’¡ Le fichier Word s'ouvrira dans Microsoft Word, LibreOffice ou Google Docs
                </p>
              </div>
            )}

            {/* Modal Ajouter PiÃ¨ce */}
            {showPieceModal && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-96 overflow-y-auto">
                  <h3 className="text-xl font-bold mb-4">SÃ©lectionner une piÃ¨ce</h3>
                  <div className="space-y-2 mb-4">
                    {PIECES_PREDEFINES.map((p) => (
                      <button
                        key={p}
                        onClick={() => ajouterPiece(p)}
                        className="w-full text-left px-4 py-2 border border-gray-300 rounded hover:bg-blue-50"
                      >
                        {p}
                      </button>
                    ))}
                  </div>
                  <input
                    type="text"
                    placeholder="Ou saisir un nom personnalisÃ©..."
                    className="w-full px-3 py-2 border border-gray-300 rounded-md mb-4"
                    onKeyDown={(e) => {
                      if (e.key === 'Enter' && e.target.value.trim()) {
                        ajouterPiece(e.target.value.trim());
                      }
                    }}
                  />
                  <button
                    onClick={() => setShowPieceModal(false)}
                    className="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400"
                  >
                    Annuler
                  </button>
                </div>
              </div>
            )}

            {/* Modal Croquis */}
            {showCroquis && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-lg p-6 max-w-2xl w-full">
                  <h3 className="text-xl font-bold mb-4">Dessiner le croquis</h3>
                  <canvas
                    ref={canvasRef}
                    width={600}
                    height={400}
                    className="border-2 border-gray-300 rounded mb-4 bg-white w-full"
                    style={{ touchAction: 'none', cursor: 'crosshair' }}
                    onMouseDown={startDrawing}
                    onMouseMove={draw}
                    onMouseUp={stopDrawing}
                    onMouseLeave={stopDrawing}
                    onTouchStart={startDrawing}
                    onTouchMove={draw}
                    onTouchEnd={stopDrawing}
                  />
                  <div className="flex gap-2 flex-wrap">
                    <button
                      onClick={effacerCroquis}
                      className="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400"
                    >
                      Effacer
                    </button>
                    <button
                      onClick={() => sauvegarderCroquis(currentPiece)}
                      className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 flex items-center gap-2"
                    >
                      <Check /> Sauvegarder
                    </button>
                    <button
                      onClick={() => {
                        setShowCroquis(false);
                        setCurrentPiece(null);
                      }}
                      className="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700"
                    >
                      Annuler
                    </button>
                  </div>
                </div>
              </div>
            )}

            <input type="file" ref={fileInputRef} accept="image/*" capture="environment" className="hidden" />
          </div>
        </div>
      );
    }

    ReactDOM.render(<ChiffrageApp />, document.getElementById('root'));
  </script>
</body>
</html>
